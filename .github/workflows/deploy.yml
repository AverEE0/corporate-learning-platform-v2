name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e  # Exit on any error
            echo "ğŸš€ Starting deployment..."
            
            # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¸Ğ»Ğ¸ ĞºĞ»Ğ¾Ğ½Ğ¸Ñ€ÑƒĞµĞ¼ Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ¹
            if [ ! -d "/root/corporate-learning-platform-v2" ]; then
              echo "ğŸ“¦ Directory not found, cloning repository..."
              cd /root
              git clone https://github.com/AverEE0/corporate-learning-platform-v2.git
            fi
            
            cd /root/corporate-learning-platform-v2
            
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ°Ğ¸Ğ²Ğ°ĞµĞ¼ git remote
            if ! git remote get-url origin > /dev/null 2>&1; then
              echo "ğŸ“¦ Setting up git remote..."
              git remote add origin https://github.com/AverEE0/corporate-learning-platform-v2.git
            else
              echo "ğŸ”„ Updating git remote URL..."
              git remote set-url origin https://github.com/AverEE0/corporate-learning-platform-v2.git
            fi
            
            echo "ğŸ“¦ Fetching latest code..."
            if ! git fetch origin; then
              echo "âš ï¸ Git fetch failed, trying direct pull..."
              if ! git pull origin main && ! git pull origin master; then
                echo "âŒ Failed to fetch/pull code!"
                exit 1
              fi
            else
              echo "ğŸ”„ Resetting to latest commit..."
              if ! git reset --hard origin/main 2>/dev/null; then
                if ! git reset --hard origin/master 2>/dev/null; then
                  echo "âš ï¸ Reset failed, trying checkout..."
                  git checkout -f main 2>/dev/null || git checkout -f master 2>/dev/null || true
                fi
              fi
            fi
            
            echo "ğŸ“ Current commit: $(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"
            echo "ğŸ—ï¸ Building Docker containers..."
            if ! docker compose build --no-cache app; then
              echo "âŒ Docker build failed!"
              exit 1
            fi
            echo "ğŸš€ Starting containers..."
            if ! docker compose up -d app; then
              echo "âŒ Failed to start containers!"
              exit 1
            fi
            echo "âœ… Checking container status..."
            sleep 5
            docker compose ps
            echo "âœ… Deployment completed successfully!"
          ENDSSH
