name: Deploy to Server

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # ะฃะผะตะฝััะตะฝะพ ะดะพ 10 ะผะธะฝัั - ะตัะปะธ ะดะตะฟะปะพะน ะฝะต ะทะฐะฒะตััะธะปัั, ะทะฝะฐัะธั ะฟัะพะฑะปะตะผะฐ
    concurrency:
      group: deploy
      cancel-in-progress: false  # ะะต ะพัะผะตะฝััั ัะตะบััะธะน ะดะตะฟะปะพะน, ะตัะปะธ ะทะฐะฟััะตะฝ ะฝะพะฒัะน
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          echo "โ SSH ะบะปัั ะฝะฐัััะพะตะฝ"
          echo "๐ ะัะพะฒะตัะบะฐ SSH ะฟะพะดะบะปััะตะฝะธั..."
          ssh -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'" || {
            echo "โ ะัะธะฑะบะฐ SSH ะฟะพะดะบะปััะตะฝะธั"
            exit 1
          }
      
      - name: Deploy to server
        timeout-minutes: 10  # ะขะฐะนะผะฐัั ะดะปั SSH ัะตััะธะธ (ัะฒะตะปะธัะตะฝะพ ะดะปั ะฟะตัะตัะฑะพัะบะธ ะฑะตะท ะบะตัะฐ)
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          ssh -o ConnectTimeout=5 -o ServerAliveInterval=15 -o ServerAliveCountMax=2 -o BatchMode=yes $SSH_USER@$SSH_HOST << 'ENDSSH'
            set -e  # Exit on any error
            
            # ะคัะฝะบัะธั ะดะปั ะปะพะณะธัะพะฒะฐะฝะธั ั ะฒัะตะผะตะฝะฝะพะน ะผะตัะบะพะน
            log() {
              echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
            }
            
            # ะคัะฝะบัะธั ะดะปั ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ
            handle_error() {
              local exit_code=$?
              local line_number=$1
              log "โ ะะจะะะะ ะฝะฐ ัััะพะบะต $line_number (exit code: $exit_code)"
              log "๐ ะะพัะปะตะดะฝะธะต ะบะพะผะฐะฝะดั:"
              history | tail -5 || true
              log "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
              log "๐ ะัะพะฒะตัะบะฐ ะพะบััะถะตะฝะธั:"
              log "   - Git: $(git --version 2>/dev/null || echo 'ะฝะต ัััะฐะฝะพะฒะปะตะฝ')"
              log "   - Docker: $(docker --version 2>/dev/null || echo 'ะฝะต ัััะฐะฝะพะฒะปะตะฝ')"
              log "   - Docker Compose: $(docker compose version 2>/dev/null || echo 'ะฝะต ัััะฐะฝะพะฒะปะตะฝ')"
              log "   - ะกะฒะพะฑะพะดะฝะพะต ะผะตััะพ: $(df -h / | tail -1 | awk '{print $4}')"
              exit $exit_code
            }
            
            trap 'handle_error $LINENO' ERR
            
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "๐ ะะะงะะะ ะะะะะะฏ"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "๐ ะะฝัะพัะผะฐัะธั ะพ ัะตัะฒะตัะต:"
            log "   - ะฅะพัั: $(hostname)"
            log "   - ะะพะปัะทะพะฒะฐัะตะปั: $(whoami)"
            log "   - ะะธัะตะบัะพัะธั: $(pwd)"
            log ""
            
            # ะจะฐะณ 1: ะัะพะฒะตัะบะฐ ะธ ะฟะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 1: ะัะพะฒะตัะบะฐ ะดะธัะตะบัะพัะธะธ ะฟัะพะตะบัะฐ"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            if [ ! -d "/root/corporate-learning-platform-v2" ]; then
              log "โ๏ธ  ะะธัะตะบัะพัะธั ะฝะต ะฝะฐะนะดะตะฝะฐ, ะบะปะพะฝะธััะตะผ ัะตะฟะพะทะธัะพัะธะน..."
              cd /root || { log "โ ะะต ัะดะฐะปะพัั ะฟะตัะตะนัะธ ะฒ /root"; exit 1; }
              
              log "๐ฆ ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั..."
              if git clone https://github.com/AverEE0/corporate-learning-platform-v2.git 2>&1; then
                log "โ ะะตะฟะพะทะธัะพัะธะน ััะฟะตัะฝะพ ะบะปะพะฝะธัะพะฒะฐะฝ"
              else
                log "โ ะัะธะฑะบะฐ ะบะปะพะฝะธัะพะฒะฐะฝะธั ัะตะฟะพะทะธัะพัะธั"
                log "   ะัะพะฒะตัััะต:"
                log "   - ะะพัััะฟ ะบ GitHub (ัะตะฟะพะทะธัะพัะธะน ะดะพะปะถะตะฝ ะฑััั ะฟัะฑะปะธัะฝัะผ ะธะปะธ ะฝะฐัััะพะตะฝ ะดะพัััะฟ)"
                log "   - ะะฝัะตัะฝะตั ัะพะตะดะธะฝะตะฝะธะต ะฝะฐ ัะตัะฒะตัะต"
                exit 1
              fi
            else
              log "โ ะะธัะตะบัะพัะธั ัััะตััะฒัะตั: /root/corporate-learning-platform-v2"
            fi
            
            cd /root/corporate-learning-platform-v2 || { log "โ ะะต ัะดะฐะปะพัั ะฟะตัะตะนัะธ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ"; exit 1; }
            log "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"
            log ""
            
            # ะจะฐะณ 2: ะะฐัััะพะนะบะฐ Git
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 2: ะะฐัััะพะนะบะฐ Git"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            # ะัะพะฒะตัะบะฐ, ััะพ ััะพ git ัะตะฟะพะทะธัะพัะธะน
            if [ ! -d ".git" ]; then
              log "โ๏ธ  ะญัะพ ะฝะต git ัะตะฟะพะทะธัะพัะธะน, ะธะฝะธัะธะฐะปะธะทะธััะตะผ..."
              if git init 2>&1; then
                log "โ Git ัะตะฟะพะทะธัะพัะธะน ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝ"
              else
                log "โ ะัะธะฑะบะฐ ะธะฝะธัะธะฐะปะธะทะฐัะธะธ git ัะตะฟะพะทะธัะพัะธั"
                exit 1
              fi
            fi
            
            # ะะฐัััะพะนะบะฐ remote
            if ! git remote get-url origin > /dev/null 2>&1; then
              log "๐ฆ ะะพะฑะฐะฒะปะตะฝะธะต git remote..."
              if git remote add origin https://github.com/AverEE0/corporate-learning-platform-v2.git 2>&1; then
                log "โ Remote ะดะพะฑะฐะฒะปะตะฝ"
              else
                log "โ ะัะธะฑะบะฐ ะดะพะฑะฐะฒะปะตะฝะธั remote"
                exit 1
              fi
            else
              log "๐ ะะฑะฝะพะฒะปะตะฝะธะต git remote URL..."
              CURRENT_REMOTE=$(git remote get-url origin)
              log "   ะขะตะบััะธะน remote: $CURRENT_REMOTE"
              if git remote set-url origin https://github.com/AverEE0/corporate-learning-platform-v2.git 2>&1; then
                log "โ Remote URL ะพะฑะฝะพะฒะปะตะฝ"
              else
                log "โ๏ธ  ะะต ัะดะฐะปะพัั ะพะฑะฝะพะฒะธัั remote, ะฟัะพะดะพะปะถะฐะตะผ..."
              fi
            fi
            
            log "๐ ะัะพะฒะตัะบะฐ remote:"
            git remote -v
            log ""
            
            # ะจะฐะณ 3: ะะพะปััะตะฝะธะต ะบะพะดะฐ (ะพะฟัะธะผะธะทะธัะพะฒะฐะฝะพ ะดะปั ัะบะพัะพััะธ)
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 3: ะะพะปััะตะฝะธะต ะบะพะดะฐ ะธะท GitHub"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            log "๐ฆ ะัะฟะพะปะฝะตะฝะธะต git fetch (ะฑัััััะน ัะฟะพัะพะฑ)..."
            # ะัะฟะพะปัะทัะตะผ --depth=1 ะดะปั ััะบะพัะตะฝะธั ะฟัะธ ะฝะตะพะฑัะพะดะธะผะพััะธ
            if git fetch origin main --quiet 2>&1 || git fetch origin master --quiet 2>&1; then
              log "โ Fetch ะฒัะฟะพะปะฝะตะฝ ััะฟะตัะฝะพ"
              
              log "๐ ะกะฑัะพั ะฝะฐ ะฟะพัะปะตะดะฝะธะน ะบะพะผะผะธั..."
              if git reset --hard origin/main 2>&1; then
                log "โ ะกะฑัะพั ะฝะฐ origin/main ะฒัะฟะพะปะฝะตะฝ"
              elif git reset --hard origin/master 2>&1; then
                log "โ ะกะฑัะพั ะฝะฐ origin/master ะฒัะฟะพะปะฝะตะฝ"
              else
                log "โ๏ธ  ะกะฑัะพั ะฝะต ัะดะฐะปัั, ะฟัะพะฑัะตะผ checkout..."
                git checkout -f main 2>/dev/null || git checkout -f master 2>/dev/null || true
                log "โ Checkout ะฒัะฟะพะปะฝะตะฝ"
              fi
            else
              log "โ๏ธ  Git fetch ะฝะต ัะดะฐะปัั, ะฟัะพะฑัะตะผ pull..."
              if git pull origin main --quiet 2>&1; then
                log "โ Pull ะธะท origin/main ะฒัะฟะพะปะฝะตะฝ"
              elif git pull origin master --quiet 2>&1; then
                log "โ Pull ะธะท origin/master ะฒัะฟะพะปะฝะตะฝ"
              else
                log "โ ะะต ัะดะฐะปะพัั ะฟะพะปััะธัั ะบะพะด ะธะท GitHub"
                log "   ะัะพะฒะตัััะต:"
                log "   - ะะพัััะฟ ะบ GitHub"
                log "   - ะัะฐะฒะธะปัะฝะพััั URL ัะตะฟะพะทะธัะพัะธั"
                log "   - ะกะพััะพัะฝะธะต git ัะตะฟะพะทะธัะพัะธั:"
                git status || true
                exit 1
              fi
            fi
            
            CURRENT_COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')
            CURRENT_MESSAGE=$(git log -1 --pretty=format:"%s" 2>/dev/null || echo 'unknown')
            log "๐ ะขะตะบััะธะน ะบะพะผะผะธั: $CURRENT_COMMIT"
            log "๐ ะกะพะพะฑัะตะฝะธะต ะบะพะผะผะธัะฐ: $CURRENT_MESSAGE"
            log ""
            
            # ะจะฐะณ 4: ะัะพะฒะตัะบะฐ Docker
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 4: ะัะพะฒะตัะบะฐ Docker"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            if ! command -v docker > /dev/null 2>&1; then
              log "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
              log "   ะฃััะฐะฝะพะฒะธัะต Docker: apt-get update && apt-get install -y docker.io"
              exit 1
            fi
            log "โ Docker ัััะฐะฝะพะฒะปะตะฝ: $(docker --version)"
            
            if ! command -v docker-compose > /dev/null 2>&1 && ! docker compose version > /dev/null 2>&1; then
              log "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ!"
              log "   ะฃััะฐะฝะพะฒะธัะต: apt-get install -y docker-compose-plugin"
              exit 1
            fi
            log "โ Docker Compose ัััะฐะฝะพะฒะปะตะฝ: $(docker compose version 2>/dev/null || docker-compose --version)"
            
            # ะัะพะฒะตัะบะฐ ัะฒะพะฑะพะดะฝะพะณะพ ะผะตััะฐ
            AVAILABLE_SPACE=$(df -h / | tail -1 | awk '{print $4}')
            log "๐พ ะกะฒะพะฑะพะดะฝะพะต ะผะตััะพ: $AVAILABLE_SPACE"
            log ""
            
            # ะจะฐะณ 5: ะัะธััะบะฐ ะบะตัะฐ Next.js ะธ ัะฑะพัะบะฐ Docker ะบะพะฝัะตะนะฝะตัะพะฒ
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 5: ะัะธััะบะฐ ะบะตัะฐ ะธ ัะฑะพัะบะฐ Docker ะบะพะฝัะตะนะฝะตัะพะฒ"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            # ะัะธััะบะฐ ะบะตัะฐ Next.js ะดะปั ะฟัะธะฝัะดะธัะตะปัะฝะพะน ะฟะตัะตัะฑะพัะบะธ
            log "๐งน ะัะธััะบะฐ ะบะตัะฐ Next.js..."
            if [ -d ".next" ]; then
              rm -rf .next
              log "โ ะะตั Next.js (.next) ัะดะฐะปะตะฝ"
            else
              log "โน๏ธ  ะะธัะตะบัะพัะธั .next ะฝะต ะฝะฐะนะดะตะฝะฐ (ััะพ ะฝะพัะผะฐะปัะฝะพ, ะตัะปะธ ััะพ ะฟะตัะฒัะน ะดะตะฟะปะพะน)"
            fi
            
            # ะัะธััะบะฐ node_modules/.cache ะตัะปะธ ะตััั
            if [ -d "node_modules/.cache" ]; then
              rm -rf node_modules/.cache
              log "โ ะะตั node_modules ัะดะฐะปะตะฝ"
            fi
            
            # ะััะฐะฝะพะฒะบะฐ ััะฐััั ะฟัะพัะตััะพะฒ ัะฑะพัะบะธ, ะตัะปะธ ะพะฝะธ ะตััั
            log "๐ ะัะพะฒะตัะบะฐ ะธ ะพััะฐะฝะพะฒะบะฐ ััะฐััั ะฟัะพัะตััะพะฒ ัะฑะพัะบะธ..."
            # ะะณัะตััะธะฒะฝะฐั ะพัะธััะบะฐ: ัะฑะธะฒะฐะตะผ ะะกะ ะฟัะพัะตััั docker compose build
            pkill -9 -f 'docker compose' 2>/dev/null || true
            pkill -9 -f 'docker build' 2>/dev/null || true
            # ะัะธััะบะฐ ะทะฐะฒะธััะธั ะบะพะฝัะตะนะฝะตัะพะฒ ัะฑะพัะบะธ
            docker ps -a --filter "status=exited" --filter "name=build" -q | xargs -r docker rm -f 2>/dev/null || true
            sleep 2
            
            log "๐๏ธ  ะะฐะฟััะบ docker compose build (ะะะะะฃะะะขะะะฌะะะฏ ะะะะะกะะะะะ ะะะ ะะญะจะ)..."
            log "   ะัะฟะพะปัะทัะตะผ --no-cache ะดะปั ะณะฐัะฐะฝัะธะธ ัะฒะตะถะตะน ัะฑะพัะบะธ"
            log "   ะญัะพ ะทะฐะนะผะตั ะฑะพะปััะต ะฒัะตะผะตะฝะธ, ะฝะพ ะณะฐัะฐะฝัะธััะตั ะฟัะธะผะตะฝะตะฝะธะต ะฒัะตั ะธะทะผะตะฝะตะฝะธะน"
            
            # ะกะฑะพัะบะฐ ั ัะฐะนะผะฐััะพะผ (ะผะฐะบัะธะผัะผ 8 ะผะธะฝัั) ะธ ะฒัะฒะพะดะพะผ ะฟัะพะณัะตััะฐ
            log "โฑ๏ธ  ะขะฐะนะผะฐัั ัะฑะพัะบะธ: 8 ะผะธะฝัั. ะัะปะธ ะฟัะตะฒััะตะฝ - ะดะตะฟะปะพะน ะฑัะดะตั ะพััะฐะฝะพะฒะปะตะฝ."
            log "๐ ะะฐะฟััะบ ัะฑะพัะบะธ..."
            
            # ะัะธะฝัะดะธัะตะปัะฝะฐั ะฟะตัะตัะฑะพัะบะฐ ะะะ ะบะตัะฐ ะดะปั ะณะฐัะฐะฝัะธะธ ะฟัะธะผะตะฝะตะฝะธั ะธะทะผะตะฝะตะฝะธะน
            if timeout 480 docker compose build --no-cache --progress=plain app 2>&1 | tee /tmp/build.log; then
              log "โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ"
            else
              BUILD_EXIT_CODE=$?
              if [ $BUILD_EXIT_CODE -eq 124 ]; then
                log "โ ะขะะะะะฃะข ัะฑะพัะบะธ Docker ะบะพะฝัะตะนะฝะตัะฐ (ะฟัะตะฒััะตะฝ ะปะธะผะธั 8 ะผะธะฝัั)"
                log "   ะญัะพ ะพะทะฝะฐัะฐะตั, ััะพ ัะฑะพัะบะฐ ะทะฐะฒะธัะปะฐ ะธะปะธ ัะปะธัะบะพะผ ะดะพะปะณะฐั"
              else
                log "โ ะัะธะฑะบะฐ ัะฑะพัะบะธ Docker ะบะพะฝัะตะนะฝะตัะฐ (ะบะพะด ะฒััะพะดะฐ: $BUILD_EXIT_CODE)"
              fi
              log "   ะัะธะฝัะดะธัะตะปัะฝะฐั ะพััะฐะฝะพะฒะบะฐ ะฒัะตั ะฟัะพัะตััะพะฒ Docker..."
              pkill -9 -f 'docker compose' 2>/dev/null || true
              pkill -9 -f 'docker build' 2>/dev/null || true
              # ะะพะบะฐะทัะฒะฐะตะผ ะฟะพัะปะตะดะฝะธะต ัััะพะบะธ ะปะพะณะฐ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ
              log "   ะะพัะปะตะดะฝะธะต ัััะพะบะธ ะปะพะณะฐ ัะฑะพัะบะธ:"
              tail -30 /tmp/build.log 2>/dev/null || echo "   ะะพะณ ะฝะตะดะพัััะฟะตะฝ"
              log "   ะัะพะฒะตัััะต:"
              log "   - docker-compose.yml ัะฐะนะป"
              log "   - Dockerfile"
              log "   - ะะพะณะธ Docker: docker compose logs"
              log "   - ะกะพััะพัะฝะธะต: docker compose ps -a"
              exit 1
            fi
            log "โ ะกะฑะพัะบะฐ ะทะฐะฒะตััะตะฝะฐ ััะฟะตัะฝะพ"
            log ""
            
            # ะจะฐะณ 6: ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 6: ะะฐะฟััะบ ะบะพะฝัะตะนะฝะตัะพะฒ"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            log "๐ ะะฐะฟััะบ docker compose up..."
            if docker compose up -d app 2>&1; then
              log "โ ะะพะฝัะตะนะฝะตัั ะทะฐะฟััะตะฝั"
            else
              log "โ ะัะธะฑะบะฐ ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ"
              log "   ะัะพะฒะตัััะต ะปะพะณะธ: docker compose logs app"
              log "   ะัะพะฒะตัััะต ัะพััะพัะฝะธะต: docker compose ps"
              exit 1
            fi
            log ""
            
            # ะจะฐะณ 7: ะัะพะฒะตัะบะฐ ััะฐัััะฐ
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "ะจะะ 7: ะัะพะฒะตัะบะฐ ััะฐัััะฐ"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            
            log "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ะบะพะฝัะตะนะฝะตัะพะฒ (5 ัะตะบัะฝะด)..."
            sleep 5
            
            log "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
            docker compose ps 2>&1 || true
            
            log ""
            log "๐ ะะพัะปะตะดะฝะธะต ะปะพะณะธ ะฟัะธะปะพะถะตะฝะธั:"
            docker compose logs --tail=20 app 2>&1 || true
            
            log ""
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "โ ะะะะะะ ะะะะะะจะะ ะฃะกะะะจะะ!"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
            log "๐ ะะพะผะผะธั: $CURRENT_COMMIT"
            log "๐ ะัะตะผั: $(date)"
            log "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
          ENDSSH
