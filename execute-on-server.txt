cd /root/corporate-learning-platform-v2 && cat > full-fix.sh << 'ENDOFFILE'
#!/bin/bash
set -e
PROJECT_DIR="/root/corporate-learning-platform-v2"
cd "$PROJECT_DIR"
echo "=== ДИАГНОСТИКА И ИСПРАВЛЕНИЕ ==="

# Проверка Docker
if ! command -v docker &> /dev/null; then
    echo "Установка Docker..."
    curl -fsSL https://get.docker.com | sh
    systemctl start docker && systemctl enable docker
fi

# Проверка и запуск Docker
systemctl start docker 2>/dev/null || true
systemctl enable docker 2>/dev/null || true

# Создание .env.local
cat > .env.local << 'EOF'
DATABASE_URL=postgresql://postgres:password@postgres:5432/learning_platform
JWT_SECRET=tfj6T/jJ5dgTqoKfZmw1hTqJYSIXO/jI1g2RRlF87bE=
NODE_ENV=production
PORT=3000
HOSTNAME=0.0.0.0
NEXT_PUBLIC_APP_URL=http://212.113.123.94:3044
EOF

# Исправление next.config.js
if [ -f "next.config.js" ]; then
    if ! grep -q "output: 'standalone'" next.config.js; then
        sed -i "s/const nextConfig = {/const nextConfig = {\n  output: 'standalone',/" next.config.js
    fi
fi

# Создание директорий
mkdir -p uploads logs && chmod 755 uploads logs

# Остановка старых процессов
pm2 stop learning-platform 2>/dev/null || true
pm2 delete learning-platform 2>/dev/null || true
docker compose down 2>/dev/null || true
docker stop corporate_learning_app corporate_learning_db 2>/dev/null || true
docker rm corporate_learning_app corporate_learning_db 2>/dev/null || true

# Создание docker-compose.yml если нет
if [ ! -f "docker-compose.yml" ]; then
cat > docker-compose.yml << 'DOCKEREOF'
version: '3.8'
services:
  postgres:
    image: postgres:16-alpine
    container_name: corporate_learning_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: learning_platform
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts:/docker-entrypoint-initdb.d
    ports:
      - "5433:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: corporate_learning_app
    restart: unless-stopped
    ports:
      - "3044:3000"
    env_file:
      - .env.local
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/learning_platform
    volumes:
      - ./uploads:/app/uploads
      - ./logs:/app/logs
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
volumes:
  postgres_data:
    driver: local
networks:
  app-network:
    driver: bridge
DOCKEREOF
fi

echo "=== СБОРКА И ЗАПУСК ==="
docker compose build --no-cache
docker compose up -d

echo "=== ОЖИДАНИЕ ЗАПУСКА ==="
sleep 15
for i in {1..12}; do
    if docker exec corporate_learning_app curl -f http://localhost:3000/api/health >/dev/null 2>&1; then
        echo "✓ Приложение готово!"
        break
    fi
    echo "Попытка $i/12..."
    sleep 5
done

echo "=== ПРОВЕРКА ==="
docker compose ps
curl -s http://localhost:3044/api/health || echo "Health check не прошел"
echo ""
echo "=== ЛОГИ (последние 20 строк) ==="
docker logs corporate_learning_app --tail=20
ENDOFFILE
chmod +x full-fix.sh && ./full-fix.sh


